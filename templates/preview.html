<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Vista previa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Vista previa para redes sociales -->
  <meta property="og:title" content="{{ config.titulo }}">
  <meta property="og:description" content="{{ config.descripcion }}">
  <meta property="og:image" content="{{ config.imagen_destacada }}">
  <meta property="og:image:type" content="image/jpeg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:url" content="{{ config.url }}">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <!-- Google Fonts disponibles -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Playfair+Display&family=Fira+Code&family=Raleway&family=Quicksand&family=Pacifico&family=Source+Serif+4&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  {% set estilo = config.estilo_visual.lower() %}
  {% if 'claro' in estilo or 'esferas' in estilo or 'blanco' in estilo %}
    {% set modo_visual = 'modo-claro' %}
  {% else %}
    {% set modo_visual = 'modo-oscuro' %}
  {% endif %}

  <style>
    body {
      font-family: {{ config.fuente | safe }};
      background-image: url("/static/img/{{ config.estilo_visual }}.jpeg");
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-position: center;
      padding-top: 70px;
    }
    h1, h2, h3, .btn, .card {
      font-family: {{ config.fuente | safe }};
    }
    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.4);
      z-index: -1;
    }
    .fondo-animado {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: -2;
      background: radial-gradient(circle at 20% 30%, rgba(255,255,255,0.08), transparent 40%),
                  radial-gradient(circle at 80% 70%, rgba(255,255,255,0.06), transparent 40%);
      animation: moverFondo 40s ease-in-out infinite;
      background-size: 200% 200%;
      pointer-events: none;
    }
    html {
      scroll-behavior: auto;
    }
    .card {
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 0.6s ease forwards;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border-radius: 12px;
      overflow: hidden;
      will-change: transform, box-shadow;
      padding: 12px;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    .modo-oscuro .card:hover {
      box-shadow: 0 8px 20px rgba(255,255,255,0.2);
    }
    .modo-claro .card:hover {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }
    .card-img-top {
      width: 100%;
      max-width: 300px;
      height: auto;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .card-body {
      padding: 10px;
    }
    .card-title {
      font-size: 1rem;
    }
    .card-text {
      font-size: 0.9rem;
    }
    .modo-claro .card {
      background-color: #fff;
      color: #333;
      border: none;
    }
    .modo-oscuro .card {
      background-color: rgba(0,0,0,0.6);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .color-principal {
      color: inherit; /* o un color fijo, ej. #ff6f61 */
    }
    .bg-principal {
      background-color: transparent; /* o un color fijo */
    }
    .modo-oscuro {
      color: white;
    }
    .modo-claro {
      color: #333;
    }
    .barra-navegacion {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(6px);
      display: flex;
      justify-content: center;
      gap: 16px;
      padding: 12px 20px;
      box-shadow: 0 2px 6px rgba(255, 255, 255, 0.1);
    }
    .barra-navegacion button {
      font-family: {{ config.fuente | safe }};
      font-weight: 600;
      font-size: 16px;
      padding: 10px 20px;
      border-radius: 30px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.05);
      color: white;
      box-shadow: 0 0 6px rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }
    .barra-navegacion button:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: scale(1.05);
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
    }
    .barra-wrapper {
      z-index: 1000;
    }
    .panel-grupos {
      position: fixed;
      max-height: 50vh; /* Altura m√°xima global */
      overflow-y: auto; /* Desplazamiento vertical global */
      left: 0;
      right: 0;
      z-index: 906;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(6px);
      padding: 1px 0;
      text-align: center;
      box-shadow: 0 2px 6px rgba(255, 255, 255, 0.1);
    }
    .panel-grupos button {
      font-family: {{ config.fuente | safe }};
      font-weight: 600;
      margin: 6px;
      padding: 2px 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 30px;
      background: rgba(255, 255, 255, 0.05);
      color: white;
      box-shadow: 0 0 6px rgba(255, 255, 255, 0.2);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .panel-grupos button:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: scale(1.05);
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
    }
    .oculta {
      display: none !important;
    }
    .logo { 
      height: 10vw; 
      max-height: 380px; 
      filter: brightness(1.5) contrast(1.2) drop-shadow(0 0 14px White);
      transition: filter 0.3s ease;
      animation: pulsoLogo 4s ease-in-out infinite;
    }
    @keyframes pulsoLogo {
      0%, 100% {
        filter: brightness(1.5) contrast(1.2) drop-shadow(0 0 14px None);
      }
      50% {
        filter: brightness(1.8) contrast(1.3) drop-shadow(0 0 20px None);
      }
    }
    .descripcion-emprendimiento {
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 20px;
      border-radius: 10px;
      display: inline-block;
      max-width: 800px;
      white-space: pre-line;
      text-align: center;
      text-indent: 20px;
      font-size: 16px;
      line-height: 1.6;
      box-shadow: 0 0 6px rgba(255,255,255,0.3);
    }
    .btn-grupo {
      position: relative;
      padding: 8px 16px;
      margin: 5px;
      border-radius: 20px;
      font-weight: bold;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 0 6px rgba(255,255,255,0.3);
      transition: all 0.3s ease;
      overflow: hidden;
    }
    .modo-claro .btn-grupo {
      background-color: transparent;
      color: white;
      border: none;
    }
    .modo-oscuro .btn-grupo {
      background-color: rgba(255, 255, 255, 0.05);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 0 4px rgba(255,255,255,0.1);
    }
    .btn-grupo::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 20px;
      z-index: -1;
    }
    .modo-claro .btn-grupo::before {
      background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.08), transparent 70%);
    }
    .modo-oscuro .btn-grupo::before {
      background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.05), transparent 70%);
    }
    .btn-grupo:hover {
      background-color: #fff;
      color: #333;
      transform: scale(1.05);
      box-shadow: 0 0 8px None;
    }
    .btn-grupo.active {
      box-shadow: none;
    }
    .btn-whatsapp {
      background-color: #25D366;
      border: none;
      padding: 8px 16px;
      color: white;
      border-radius: 5px;
      font-size: 14px;
    }
    .btn-volver-arriba {
      background-color: white;
      color: black;
      border: none;
      font-size: 20px;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-volver-arriba:hover {
      background-color: #f0f0f0;
      transform: scale(1.1);
    }
    .btn-volver-arriba:focus,
    .btn-volver-arriba:active,
    .btn-volver-arriba:visited {
      outline: none;
      box-shadow: none;
      background-color: white;
      color: black;
    }
    .grupo-section {
      display: none;
      min-height: 100vh;
    }
    .grupo-section.active {
      display: block !important;
    }
    .social-icons {
      margin-top: 40px;
      text-align: center;
    }
    .social-icons img {
      width: 40px;
      margin: 0 10px;
      transition: transform 0.3s ease;
      filter: drop-shadow(0 0 3px white);
    }
    .social-icons img:hover {
      transform: scale(1.1);
      filter: drop-shadow(0 0 0 transparent);
    }
    .bloque-ubicacion {
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 12px 16px;
      border-radius: 10px;
      text-align: center;
      max-width: 600px;
      margin: 20px auto 0;
      box-shadow: 0 0 6px rgba(255,255,255,0.3);
    }
    #carrito {
      position: fixed;
      bottom: 80px;
      right: 20px;
      padding: 15px;
      border-radius: 10px;
      width: 300px;
      z-index: 999;
      display: none;
    }
    .modo-oscuro #carrito {
      background-color: rgba(0,0,0,0.85);
      color: white;
      border: 1px solid white;
      box-shadow: 0 0 10px white;
    }
    .modo-claro #carrito {
      background-color: #fff;
      color: #333;
      border: 1px solid #ccc;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    #toggleCarrito {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      padding: 10px 14px;
      border-radius: 50px;
      font-weight: bold;
      box-shadow: 0 0 5px white;
    }
    .modo-oscuro #toggleCarrito {
      background-color: transparent;
      color: black;
      border: none;
    }
    .modo-claro #toggleCarrito {
      background-color: transparent;
      color: white;
      border: none;
    }
    .panel-subcategorias {
      position: fixed;
      max-height: 50vh; /* Altura m√°xima global */
      overflow-y: auto; /* Desplazamiento vertical global */
      left: 0;
      right: 0;
      z-index: 908;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(6px);
      padding: 1px 0;
      text-align: center;
      box-shadow: 0 2px 6px rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }
    .panel-subcategorias button {
      font-family: {{ config.fuente | safe }};
      font-weight: 600;
      margin: 6px;
      padding: 1px 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 30px;
      background: rgba(255, 255, 255, 0.05);
      color: white;
      box-shadow: 0 0 6px rgba(255, 255, 255, 0.2);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .panel-subcategorias button:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: scale(1.05);
    }
    @media (max-width: 600px) {
  .logo {
    height: 140px !important;
  }
  .barra-navegacion {
    padding: 8px 10px;
    gap: 8px;
  }
  .barra-navegacion button {
    font-size: 14px;
    padding: 8px 15px;
  }
  .panel-grupos {
    padding: 1px 0;
    max-height: 50vh; /* Altura m√°xima para que sea desplazable si hay muchos botones */
    overflow-y: auto; /* Hace el panel desplazable verticalmente */
  }
  .panel-grupos button {
    font-size: 13px;
    padding: 1px 6px;
    border-radius: 8px;
   }
  .panel-subcategorias {
    padding: 1px 0;
    max-height: 50vh; /* Altura m√°xima para el panel de subcategor√≠as */
    overflow-y: auto; /* Hace el panel desplazable verticalmente */
  }
  .panel-subcategorias button {
    font-size: 13px;
    padding: 1px 6px;
    border-radius: 8px;
  }
}
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes moverFondo {
      0% { background-position: 0% 0%; }
      50% { background-position: 100% 100%; }
      100% { background-position: 0% 0%; }
    }
  </style>
</head>
<body class="container py-5 {{ modo_visual }}">
  <div class="barra-wrapper">
    <nav class="barra-navegacion">
      <button id="btnProductos" onclick="mostrarTodos()">Productos</button>
      <button id="btnContacto" onclick="irAContacto()">Contacto</button>
    </nav>
    <div id="panelGrupos" class="panel-grupos oculta">
      {% for grupo in grupos.keys() %}
        <button class="btn-grupo" onclick="mostrarGrupo('{{ grupo }}', event)">
          {{ grupo }}
        </button>
      {% endfor %}
    </div>
  </div>

  <div id="panelSubcategorias" class="panel-subcategorias oculta"></div>

  <button id="volverArriba" class="btn btn-volver-arriba" style="position: fixed; bottom: 20px; left: 20px; display: none; z-index: 1000;">
    ‚Üë
  </button>

  {% if config.logo %}
    <div class="text-center my-3">
      <img src="{{ url_for('static', filename='img/' + config.logo) }}"
           alt="Logo"
           class="img-fluid logo mx-auto d-block">
    </div>
  {% endif %}


  {% if modoAdminIntentado and not modoAdmin %}
    <div id="login-admin" class="container mt-4">
      <h3 class="text-center">üîê Ingres√° tu clave de administrador</h3>
      <form id="form-login-admin" class="text-center">
        <input type="text" id="usuario_login" placeholder="Usuario" required>
        <input type="password" id="clave_login" placeholder="Contrase√±a" required>
        <button type="submit" style="margin-top: 10px;">Entrar</button> <!-- ‚úÖ Este es el que faltaba -->
      </form>
    </div>
  {% endif %}

  {% if modoAdmin %}
  <div class="text-center mt-3">
    <!-- üîì Bot√≥n para salir del modo administrador -->
    <a href="/logout-admin" class="btn btn-sm btn-outline-light">üîì Salir del modo administrador</a>

    <!-- üí≥ Bot√≥n para configurar / reconfigurar Mercado Pago -->
    <a href="{{ url_for('conectar_mp') }}" class="btn btn-sm btn-primary mt-2">
      <img src="{{ url_for('static', filename='img/mercadopago.png') }}" 
           alt="Mercado Pago" style="height:20px; margin-right:8px;">
      {% if config.mercado_pago %}
        Reconfigurar Mercado Pago
      {% else %}
        Configurar Mercado Pago
      {% endif %}
    </a>
  </div>
{% endif %}


  <div class="text-center my-4">
    <select id="ordenPrecio" class="form-select w-auto d-inline-block">
      <option value="asc">Precio: Menor a mayor</option>
      <option value="desc">Precio: Mayor a menor</option>
    </select>
  </div>


  {% if config.sobre_mi %}
    <div class="text-center mb-4">
      <div class="descripcion-emprendimiento">
        {{ config.sobre_mi | replace('\n', '<br>') | safe }}
      </div>
    </div>
  {% endif %}

{% for grupo, subgrupos in grupos.items() %}
  <div id="grupo_{{ grupo | lower | replace(' ', '_') }}" class="grupo-section">
    {% for subgrupo, productos in subgrupos.items() %}
      <div class="subgrupo-bloque" data-subgrupo="{{ subgrupo | lower | trim }}">
        <div class="row">
          {% for producto in productos %}
            {% set id_base = producto.id_base %}

            <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
              {% if modoAdmin %}
                <div class="text-muted small mb-2">
                  <strong>ID base:</strong> {{ id_base }} |
                  <strong>Grupo:</strong> {{ grupo }} |
                  <strong>Subgrupo:</strong> {{ subgrupo }} |
                  <strong>Nombre:</strong> {{ producto.nombre }} |
                  <strong>Orden:</strong> {{ producto.orden }}
                </div>
              {% endif %}

              <div class="card p-3 h-100">
                <!-- ‚úÖ Imagen con Backblaze + fallback GitHub -->
                <img src="{{ producto.imagen_backblaze or producto.imagen_github or '/static/img/fallback.webp' }}"
                     class="card-img-top"
                     alt="{{ producto.nombre }}"
                     loading="lazy">

                <div class="card-body">
                  {% if modoAdmin %}
                    <div class="text-muted small mb-2">
                      <strong>ID base:</strong> {{ id_base }}
                    </div>
                  {% endif %}

                  <h5 class="card-title">{{ producto.nombre }}</h5>
                  <p class="card-text">{{ producto.descripcion }}</p>

                  <p>
                    <strong>Precio:</strong> 
                    $<span id="precio_{{ id_base }}">{{ producto.precio }}</span>
                    {% if modoAdmin %}
                      <button onclick="editarPrecio('{{ id_base }}')" class="btn btn-sm btn-outline-secondary ms-2">üñâ</button>
                    {% endif %}
                  </p>

                  <div class="mb-2">
                    <label for="talle_{{ id_base }}" class="form-label mb-1" style="font-size: 14px;">
                      <strong>Talle:</strong>
                    </label>
                    <select id="talle_{{ id_base }}" class="form-select form-select-sm w-auto d-inline-block">
                      {% if producto.talles %}
                        {% for t in producto.talles %}
                          <option value="{{ t }}">{{ t }}</option>
                        {% endfor %}
                      {% else %}
                        <option value="">Sin talles</option>
                      {% endif %}
                    </select>
                    {% if modoAdmin %}
                      <button onclick="editarTalles('{{ id_base }}')" class="btn btn-sm btn-outline-secondary ms-2">üñâ</button>
                    {% endif %}
                  </div>

                  {% if config.whatsapp %}
                    <a href="{{ config.whatsapp }}" class="btn btn-whatsapp">Contactar por WhatsApp</a>
                  {% endif %}

                  <div class="mt-2 d-flex flex-wrap align-items-center gap-2">
                    <label for="cantidad_{{ id_base }}" class="mb-0" style="font-size: 14px;">Cantidad:</label>
                    <input type="number" min="1" max="100" value="1"
                           class="form-control form-control-sm" style="width: 70px;"
                           id="cantidad_{{ id_base }}">
                    <button type="button" class="btn btn-secondary"
                      onclick="agregarAlCarritoDOM('{{ producto.nombre }}',
                                                   'precio_{{ id_base }}',
                                                   'cantidad_{{ id_base }}',
                                                   '{{ id_base }}')">
                      Agregar al carrito
                    </button>
                  </div>
                </div>
              </div>
            </div>

          {% endfor %}
        </div>
      </div>
    {% endfor %}
  </div>
{% endfor %}


  <div id="contenedor-grupos"></div>

  <div class="text-center mt-5">
    <a href="/descargar" class="btn btn-primary px-5">
      Descargar sitio
    </a>
  </div>

  <div class="social-icons">
    {% if config.facebook %}
      <a href="{{ config.facebook }}" target="_blank">
        <img src="/static/img/facebook.png" alt="Facebook">
      </a>
    {% endif %}
    {% if config.instagram %}
      <a href="{{ config.instagram }}" target="_blank">
        <img src="/static/img/instagram.png" alt="Instagram">
      </a>
    {% endif %}
    {% if config.whatsapp %}
      <a href="{{ config.whatsapp }}" target="_blank">
        <img src="/static/img/whatsapp.png" alt="WhatsApp">
      </a>
    {% endif %}
  </div>

  {% if config.ubicacion %}
    <div id="ubicacion" class="bloque-ubicacion text-center mt-4">
      <p style="margin-bottom: 6px;">
        üìç {{ config.ubicacion }}
      </p>
      {% if config.link_mapa %}
        <a href="{{ config.link_mapa }}" target="_blank" style="text-decoration: none;">
          <span style="margin-right: 6px;">‚ûú</span>
          <img src="/static/img/map.png" alt="Ver en Google Maps" style="width: 30px;">
        </a>
      {% endif %}
    </div>
  {% endif %}

  <button id="toggleCarrito">üõí</button>

  <div id="carrito">
    <h5>üõí Tu carrito</h5>
    <ul id="listaCarrito"></ul>
    <p><strong>Total:</strong> $<span id="totalCarrito">0</span></p>
    <div class="d-grid gap-2">
  <button class="btn btn-sm btn-danger" onclick="vaciarCarrito()">Vaciar carrito</button>

  {% if config.mercado_pago and config.public_key %}
    <button id="btn_pagar" class="btn btn-sm btn-primary" onclick="pagarConMercadoPago()">Pagar con Mercado Pago</button>
  {% else %}
    <a id="enviarCarrito" class="btn btn-sm btn-success" target="_blank">Enviar por WhatsApp</a>
  {% endif %}

  </div>
<!-- Aviso flotante de precio actualizado -->
<div id="avisoPrecio" class="alert alert-success text-center" role="alert"
     style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999;">
  ‚úî Precio actualizado
</div>

    <!-- Aviso flotante de talle actualizado -->
<div id="avisoTalle" class="alert alert-info text-center" role="alert"
     style="display: none; position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); z-index: 9999;">
  ‚úî Talle actualizado
</div>

  <script>
    const configWhatsApp = "{{ config.whatsapp }}";

    window.addEventListener('scroll', () => {
      const btn = document.getElementById('volverArriba');
      btn.style.display = window.scrollY > 300 ? 'block' : 'none';
      btn.style.backgroundColor = 'white';
      btn.style.color = 'black';
    });
    const subcategoriasPorGrupo = {
      {% for grupo, subgrupos in grupos.items() %}
        "{{ grupo }}": [{% for sub in subgrupos.keys() %}"{{ sub }}"{% if not loop.last %}, {% endif %}{% endfor %}],
      {% endfor %}
    };

    document.getElementById('volverArriba').onclick = () => {
      window.scrollTo({ top: 0, behavior: 'auto' }); // Cambiado a 'auto' para evitar deslizamiento
    };
    
   function mostrarGrupo(nombre, event, auto = false) {
  const grupoId = 'grupo_' + nombre.toLowerCase().replace(/\s+/g, '_');
  const grupoActivo = document.getElementById(grupoId);

  // Resetear estado de grupos
  document.querySelectorAll('.grupo-section').forEach(div => 
    div.classList.remove('active', 'initial-load')
  );
  if (grupoActivo) {
    grupoActivo.classList.add('active');
    if (auto) grupoActivo.classList.add('initial-load');
  }

  // Resetear botones de grupo
  document.querySelectorAll('.btn-grupo').forEach(btn => btn.classList.remove('active'));
  if (event?.target) event.target.classList.add('active');

  // Subcategor√≠as din√°micas
  const subcategorias = subcategoriasPorGrupo[nombre] || [];
  const panel = document.getElementById('panelSubcategorias');
  panel.innerHTML = '';

  const bloques = grupoActivo?.querySelectorAll('.subgrupo-bloque');

  subcategorias.forEach(sub => {
    if (!sub || sub.trim().toLowerCase() === 'general') return;
    const btn = document.createElement('button');
    btn.textContent = sub;
    btn.className = 'btn-grupo';
    btn.onclick = () => filtrarSubcategoria(nombre, sub);
    panel.appendChild(btn);
  });

  if (!auto) {
    panel.classList.remove('oculta');
    bloques?.forEach(bloque => {
      bloque.style.display = 'block';
    });

    if (subcategorias.length > 0) {
      filtrarSubcategoria(nombre, subcategorias[0]);
    }
  } else {
    panel.classList.add('oculta');
    if (subcategorias.length > 0) {
      filtrarSubcategoria(nombre, subcategorias[0]);
    }
  }
}

   function filtrarSubcategoria(grupo, subgrupo) {

  const grupoId = 'grupo_' + grupo.toLowerCase().replace(/\s+/g, '_');
  const grupoDiv = document.getElementById(grupoId);
  if (!grupoDiv) {
    console.warn("‚ö†Ô∏è Grupo no encontrado:", grupoId);
    return;
  }
  const bloques = grupoDiv.querySelectorAll('.subgrupo-bloque');

  bloques.forEach((bloque, i) => {
    const subgrupoActual = bloque.dataset.subgrupo?.trim() || '';
    const mostrar = subgrupoActual.toLowerCase() === subgrupo.trim().toLowerCase();
    bloque.style.display = mostrar ? 'block' : 'none';
  });

  window.scrollTo({ top: 0, behavior: 'auto' });
}

window.onload = function() {
  const panelSubcategorias = document.getElementById('panelSubcategorias');
  const panelGrupos = document.getElementById('panelGrupos');
  panelSubcategorias.classList.add('oculta');
  panelGrupos.classList.add('oculta');

  const primerGrupo = Object.keys(subcategoriasPorGrupo)[0];
  const primerSub = subcategoriasPorGrupo[primerGrupo]?.find(s => s.toLowerCase() !== 'general') || '';
  if (primerGrupo && primerSub) {
    mostrarGrupo(primerGrupo, null, true);
    filtrarSubcategoria(primerGrupo, primerSub);
  }

  document.getElementById('toggleCarrito').onclick = function() {
    const carritoDiv = document.getElementById('carrito');
    if (!carritoDiv) return;
    carritoDiv.style.display = carritoDiv.style.display === 'none' ? 'block' : 'none';
  };
};


    let carrito = [];

   function agregarAlCarritoDOM(nombre, idPrecioSpan, idCantidad, id_base) {
  const cantidadInput = document.getElementById(idCantidad);
  const precioSpan = document.getElementById(idPrecioSpan);
  const talleSelect = document.getElementById("talle_" + id_base);

  const cantidad = parseInt(cantidadInput?.value) || 1;
  const precio = parseFloat(precioSpan?.textContent?.trim()) || 0;
  const talleElegido = talleSelect?.value || "";

  const existente = carrito.find(item => item.id_base === id_base && item.talle === talleElegido);
  if (existente) {
    existente.cantidad += cantidad;
  } else {
    const nuevoItem = { nombre, precio, cantidad, id_base, talle: talleElegido };
    carrito.push(nuevoItem);
  }

  actualizarCarrito();
}

async function pagarConMercadoPago() {
  try {
    const response = await fetch('/pagar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ carrito })
    });
    const data = await response.json();

    if (data.preference_id && mp) {
      // ‚úÖ Abrir checkout con MercadoPago.js V2
      try {
        mp.checkout({
          preference: { id: data.preference_id },
          autoOpen: true
        });
      } catch (err) {
        console.error("‚ö†Ô∏è Error en checkout:", err);
        alert("No se pudo abrir el checkout");
      }
    } else if (data.init_point) {
      // ‚úÖ Fallback al checkout cl√°sico
      window.location.href = data.init_point;
    } else {
      alert("Error al generar el pago: " + (data.error || "desconocido"));
    }
  } catch (err) {
    console.error("‚ö†Ô∏è Error al conectar con /pagar:", err);
    alert("Error interno al intentar pagar");
  }
}


function editarPrecio(id) {
  const span = document.getElementById("precio_" + id);
  if (!span) {
    return; // si no existe el span, no hace nada
  }

  const valorActual = span.textContent.replace("$", "").trim();

  const input = document.createElement("input");
  input.type = "number";
  input.value = valorActual;
  input.className = "form-control form-control-sm d-inline-block";
  input.style.width = "80px";
  input.id = "input_precio_" + id;

  // Guardar al salir del input
  input.onblur = () => {
    guardarPrecio(id);
  };

  // Guardar al presionar Enter
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      input.blur(); // dispara onblur
    }
  });

  span.replaceWith(input);
  input.focus();
}

function guardarPrecio(id) {
  const input = document.getElementById("input_precio_" + id);
  if (!input) {
    return; // si no existe el input, no hace nada
  }

  const nuevoValor = parseFloat(input.value);
  if (isNaN(nuevoValor)) {
    alert("‚ùå El precio ingresado no es v√°lido");
    return;
  }

  fetch('/actualizar-precio', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id, nuevoPrecio: nuevoValor })
  })
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok") {
        // Feedback visual inmediato en DOM
        const span = document.createElement("span");
        span.id = "precio_" + id;
        const fmt = new Intl.NumberFormat('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        span.textContent = fmt.format(nuevoValor);
        span.className = input.className;
        span.classList.add("text-success");
        input.replaceWith(span);
        setTimeout(() => span.classList.remove("text-success"), 1000);

        if (typeof mostrarAvisoPrecio === "function") mostrarAvisoPrecio();
      } else {
        alert("‚ùå No se pudo actualizar el precio en el servidor");
      }
    })
    .catch(() => {
      alert("‚ùå Error de conexi√≥n al guardar el precio");
    });
}

function loginAdmin(event) {
  event.preventDefault();

  const usuario = document.getElementById("usuario_login").value.trim();
  const clave = document.getElementById("clave_login").value.trim();

  const btn = event.target.querySelector('button[type="submit"]');
  if (btn) {
    btn.disabled = true;
    btn.textContent = 'Entrando...';
  }

  fetch("/login-admin", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ usuario, clave })
  })
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok") {
        alert("‚úÖ Acceso concedido");
        location.href = window.location.href;
      } else {
        alert("‚ùå " + data.message);
      }
    })
    .catch(() => {
      alert("‚ùå Error al intentar login");
    })
    .finally(() => {
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'Entrar';
      }
    });
}

document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("form-login-admin");
  if (form) {
    form.addEventListener("submit", loginAdmin);
  }
});

function editarTalles(id) {
  const select = document.getElementById("talle_" + id);
  if (!select) {
    return; // si no existe el select, no hace nada
  }

  const opciones = Array.from(select.options).map(opt => opt.value).filter(Boolean);
  const valorActual = opciones.join(", ");

  const input = document.createElement("input");
  input.type = "text";
  input.value = valorActual;
  input.className = "form-control form-control-sm d-inline-block";
  input.style.width = "200px";
  input.id = "input_talles_" + id;

  input.onblur = () => {
    guardarTalles(id);
  };

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") input.blur();
  });

  select.replaceWith(input);
  input.focus();
}

function guardarTalles(id) {
  const input = document.getElementById("input_talles_" + id);
  if (!input) {
    return; // si no existe el input, no hace nada
  }

  const nuevosTalles = input.value.split(",").map(t => t.trim()).filter(t => t);

  fetch('/actualizar-talles', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id, talles: nuevosTalles })
  })
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok") {
        const nuevoSelect = document.createElement("select");
        nuevoSelect.id = "talle_" + id;
        nuevoSelect.className = "form-select form-select-sm w-auto d-inline-block";

        if (nuevosTalles.length > 0) {
          nuevosTalles.forEach(t => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            nuevoSelect.appendChild(opt);
          });
        } else {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "Sin talles";
          nuevoSelect.appendChild(opt);
        }

        input.replaceWith(nuevoSelect);
        nuevoSelect.classList.add("text-success");
        setTimeout(() => nuevoSelect.classList.remove("text-success"), 1000);
      } else {
        alert("‚ùå No se pudo actualizar los talles en el servidor");
      }
    })
    .catch(() => {
      alert("‚ùå Error de conexi√≥n al guardar los talles");
    });
}

function actualizarFirestore(id, datos) {
  if (!id || typeof datos !== "object" || Object.keys(datos).length === 0) {
    return; // no hace nada si los datos son inv√°lidos
  }

  fetch("/actualizar-firestore", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id, ...datos })
  })
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok") {
        if (typeof mostrarAvisoFirestore === "function") {
          mostrarAvisoFirestore();
        }
      } else {
        alert("‚ùå No se pudo actualizar Firestore");
      }
    })
    .catch(() => {
      alert("‚ùå Error de conexi√≥n al guardar los datos");
    });
}


    function guardarProducto(producto) {
  fetch('/guardar-producto', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ producto })
  })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'ok') {
        mostrarAviso("Producto guardado correctamente");
      } else {
        mostrarAviso("‚ùå Error al guardar producto");
      }
    })
    .catch(() => {
      mostrarAviso("‚ùå Error de conexi√≥n");
    });
}

function cargarProductos() {
  fetch('/ver-productos')
    .then(res => res.json())
    .then(productos => {
      renderizarProductos(productos);
    })
    .catch(() => {
      mostrarAviso("‚ùå Error al cargar productos");
    });
}

function mostrarAvisoPrecio() {
  const aviso = document.getElementById("avisoPrecio");
  aviso.style.display = "block";
  setTimeout(() => {
    aviso.style.display = "none";
  }, 2000);
}

function eliminarProducto(id_base, talle, event) {
  event.stopPropagation();
  carrito = carrito.filter(p => !(p.id_base === id_base && p.talle === talle));
  actualizarCarrito();
}

function vaciarCarrito() {
  carrito = [];
  actualizarCarrito();
}

function actualizarPrecioEnCarrito(nombre, nuevoPrecio) {
  let cambio = false;
  carrito.forEach(item => {
    if (item.nombre === nombre && item.precio !== nuevoPrecio) {
      item.precio = nuevoPrecio;
      cambio = true;
    }
  });
  if (cambio) actualizarCarrito();
}

function sincronizarPreciosDelCarrito() {
  carrito.forEach(item => {
    const idPrecio = "precio_" + (item.id_base || item.nombre.replace(/ /g, "_"));
    const precioSpan = document.getElementById(idPrecio);
    if (precioSpan) {
      const precioActual = parseFloat(precioSpan.textContent);
      if (!isNaN(precioActual)) {
        item.precio = precioActual;
      }
    }
  });
}


function actualizarCarrito() {
  sincronizarPreciosDelCarrito();

  const lista = document.getElementById('listaCarrito');
  const total = document.getElementById('totalCarrito');
  if (!lista || !total) {
    return; // si no existen los elementos, no hace nada
  }

  lista.innerHTML = '';
  let suma = 0;

  carrito.forEach(item => {
    const subtotal = item.precio * item.cantidad;
    suma += subtotal;

    lista.innerHTML += `
      <li style="display: flex; justify-content: space-between; align-items: center;">
        <span>${item.nombre}${item.talle ? ' (' + item.talle + ')' : ''} x ${item.cantidad} - $${subtotal.toFixed(2)}</span>
        <button onclick="eliminarProducto('${item.id_base}', '${item.talle}', event)" 
                style="background: none; border: none; color: red; font-weight: bold; font-size: 16px; cursor: pointer;">
          ‚ùå
        </button>
      </li>`;
  });

  total.textContent = suma.toFixed(2);

  const mensaje = encodeURIComponent(
    `Hola, quiero consultar por:\n` +
    carrito.map(i => `- ${i.nombre}${i.talle ? ' (' + i.talle + ')' : ''} x ${i.cantidad}: $${(i.precio * i.cantidad).toFixed(2)}`).join('\n') +
    `\nTotal estimado: $${suma.toFixed(2)}`
  );

  const link = document.getElementById('enviarCarrito');
  if (link) {
    link.href = configWhatsApp + '?text=' + mensaje;
  }
}

    function mostrarTodos() {
      const panelGrupos = document.getElementById('panelGrupos');
      const panelSub = document.getElementById('panelSubcategorias');

      panelGrupos.classList.toggle('oculta');

      if (!panelSub.classList.contains('oculta')) {
        panelSub.classList.add('oculta');
      }
    }
    function irAContacto() {
      const contacto = document.getElementById('ubicacion');
      if (contacto) contacto.scrollIntoView({ behavior: 'auto' }); // Cambiado a 'auto'
    }
    function ajustarPosicionesPaneles() {
      const panelGrupos = document.getElementById('panelGrupos');
      const panelSub = document.getElementById('panelSubcategorias');
      const barraNav = document.querySelector('.barra-navegacion');

      if (!panelGrupos.classList.contains('oculta')) {
        const alturaBarra = barraNav ? barraNav.offsetHeight : 0;
        const alturaGrupos = panelGrupos ? panelGrupos.offsetHeight : 0;
        panelGrupos.style.top = alturaBarra + 'px';
        panelGrupos.style.position = 'fixed';
        panelGrupos.style.left = '0';
        panelGrupos.style.right = '0';
      }
      if (!panelSub.classList.contains('oculta')) {
        const alturaBarra = barraNav ? barraNav.offsetHeight : 0;
        const alturaGrupos = panelGrupos ? panelGrupos.offsetHeight : 0;
        const margenAdicional = 19; // Margen para evitar superposiciones
        const desplazamientoArriba = -20; // Ajuste para subir un poco si lo necesitas
        panelSub.style.top = (alturaBarra + alturaGrupos + margenAdicional + desplazamientoArriba) + 'px';
        panelSub.style.position = 'fixed';
        panelSub.style.left = '0';
        panelSub.style.right = '0';
      } else {
        panelSub.style.top = '';
      }
    }
    // Recalcular posiciones al cargar y al cambiar el tama√±o de la ventana
    window.addEventListener('load', ajustarPosicionesPaneles);
    window.addEventListener('resize', ajustarPosicionesPaneles);
    // Recalcular posiciones cuando se muestra un panel
    document.getElementById('btnProductos').addEventListener('click', function() {
      setTimeout(ajustarPosicionesPaneles, 0); // Ajuste despu√©s de que el DOM se actualice
    });
    document.querySelectorAll('.btn-grupo').forEach(btn => {
      btn.addEventListener('click', function() {
        setTimeout(ajustarPosicionesPaneles, 0); // Ajuste despu√©s de mostrar subcategor√≠as
      });
    });
  </script>
  <script type="module">
  const usarFirestore = {{ 'true' if config.usarFirestore else 'false' }};
  const email = "{{ session.get('email') or '' }}";
  const modoAdmin = {{ 'true' if modoAdmin else 'false' }};
  const grupos = {{ grupos|tojson }};

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
  import { getFirestore, doc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "{{ firebase_config.apiKey }}",
    authDomain: "{{ firebase_config.authDomain }}",
    projectId: "{{ firebase_config.projectId }}",
    storageBucket: "{{ firebase_config.storageBucket }}",
    messagingSenderId: "{{ firebase_config.messagingSenderId }}",
    appId: "{{ firebase_config.appId }}"
  };


  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  if (usarFirestore && email) {
    const usuarioDoc = doc(db, "usuarios", email);
    const productosRef = collection(usuarioDoc, "productos");

    onSnapshot(productosRef, (snapshot) => {
      const productos = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

      productos.forEach(p => {
        const precioSpan = document.getElementById("precio_" + p.id_base);
        if (precioSpan && typeof p.precio === "number") {
          const fmt = new Intl.NumberFormat("es-AR", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          });
          precioSpan.textContent = fmt.format(p.precio);
        }

        const talleSelect = document.getElementById("talle_" + p.id_base);
        if (talleSelect && Array.isArray(p.talles)) {
          talleSelect.innerHTML = p.talles
            .map(t => `<option value="${t}">${t}</option>`)
            .join("");
        }
      });
    });
  }

  setTimeout(() => {
    const grupoKeys = Object.keys(grupos);
    if (grupoKeys.length === 0) return;

    const primerGrupoId = grupoKeys[0].trim().toLowerCase().replace(/\s+/g, '_');
    const primerGrupoDiv = document.getElementById('grupo_' + primerGrupoId);
    if (primerGrupoDiv) primerGrupoDiv.classList.add('active');

    const subgrupos = Object.keys(grupos[grupoKeys[0]]);
    const primerSubgrupoNombre = subgrupos[0]?.trim().toLowerCase();

    if (primerGrupoId && primerSubgrupoNombre) {
      filtrarSubcategoria(grupoKeys[0], subgrupos[0]);
    }
  }, 100);

  // Cerrar carrito al hacer clic fuera (listener √∫nico)
  document.addEventListener('click', function(event) {
    const carritoDiv = document.getElementById('carrito');
    const toggleBtn = document.getElementById('toggleCarrito');
    if (!carritoDiv || !toggleBtn) return;

    const visible = carritoDiv.style.display === 'block';
    const clicFuera = !carritoDiv.contains(event.target) && !toggleBtn.contains(event.target);
    if (visible && clicFuera) {
      carritoDiv.style.display = 'none';
    }
  });

  // Ordenar productos por precio (listener √∫nico)
  document.getElementById('ordenPrecio')?.addEventListener('change', function () {
    const orden = this.value;
    const grupoActivo = document.querySelector('.grupo-section.active');
    if (!grupoActivo) return;

    const bloques = grupoActivo.querySelectorAll('.subgrupo-bloque');
    bloques.forEach(bloque => {
      const productos = Array.from(bloque.querySelectorAll('.col-lg-4, .col-md-6, .col-sm-12'));
      const contenedor = bloque.querySelector('.row');
      if (!contenedor) return;

      productos.sort((a, b) => {
        const precioA = parseFloat(a.querySelector('span[id^="precio_"]').textContent) || 0;
        const precioB = parseFloat(b.querySelector('span[id^="precio_"]').textContent) || 0;
        return orden === 'asc' ? precioA - precioB : precioB - precioA;
      });

      contenedor.innerHTML = '';
      productos.forEach(p => contenedor.appendChild(p));
    });
  });

  // Ocultar paneles al hacer clic fuera (listener √∫nico)
  document.addEventListener('click', function(event) {
    const panelGrupos = document.getElementById('panelGrupos');
    const panelSub = document.getElementById('panelSubcategorias');
    if (!panelGrupos || !panelSub) return;

    const esClickDentroGrupos = panelGrupos.contains(event.target);
    const esClickDentroSub = panelSub.contains(event.target);
    const esBotonGrupo = event.target.classList.contains('btn-grupo');
    const esBotonNavegacion = !!event.target.closest('.barra-navegacion');

    if (!esClickDentroGrupos && !esClickDentroSub && !esBotonGrupo && !esBotonNavegacion) {
      panelGrupos.classList.add('oculta');
      panelSub.classList.add('oculta');
    }
  });

</script>
<script src="https://sdk.mercadopago.com/js/v2"></script>
<script>
  const PUBLIC_KEY = "{{ config.public_key or '' }}";
  let mp = null;

  if (PUBLIC_KEY) {
    mp = new MercadoPago(PUBLIC_KEY, { locale: 'es-AR' });
  }

  const pagarBtn = document.getElementById('btn_pagar');
  if (pagarBtn && !PUBLIC_KEY) {
    pagarBtn.disabled = true;
  }

  console.log("PUBLIC_KEY:", PUBLIC_KEY);
</script>
</body>
</html>
